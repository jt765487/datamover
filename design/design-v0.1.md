# Requirements Document: `exportcliv8` Instance Management & Data Mover

**Version:** 0.1
**Date:** May 17, 2025

## 1. Introduction

### 1.1 Purpose
This document outlines the requirements for starting, stopping, and restarting:
1.  The external application `exportcliv8` (multiple instances).
2.  The Data Mover application responsible for overseeing `exportcliv8` and reliably processing the data it generates.

The solution must support running multiple, uniquely configured instances of `exportcliv8` and integrate with the Data Mover application's directory structure and workflow. The Data Mover application, in turn, will detect and signal "stuck" `exportcliv8` instances for restart. Both systems will be managed via `systemd`. Example `systemd` configurations meeting these requirements will be provided in separate supporting documents.

### 1.2 Scope
*   **`exportcliv8` Management:**
    *   Starting multiple independent instances of `exportcliv8` with unique configurations using `systemd` template units.
    *   Stopping these instances.
    *   Restarting individual `exportcliv8` instances in response to a trigger mechanism initiated by the Data Mover application.
    *   Configuration of `exportcliv8` command-line parameters.
*   **Data Mover Application Management:**
    *   Starting, stopping, and restarting the Data Mover application using `systemd`.
    *   Configuration of the Data Mover application's `systemd` service unit for robust operation, including automatic restarts on failure and startup validation of its directory structure.
*   **Integration & Deployment:**
    *   Alignment of `exportcliv8` output paths with the Data Mover's `base_dir` structure (`/opt/bit_mover`).
    *   Definition of responsibilities for directory creation (RPMs) and validation (applications).
    *   Strategy for file permissions and inter-service access using dedicated users and a shared group.
*   The Data Mover application is a separate RPM-deployed service, running under its own dedicated system user, responsible for the end-to-end processing of `.pcap` files and for creating trigger files for `exportcliv8` restarts.
a
### 1.3 Definitions and Glossary
*   **`exportcliv8`**: The external command-line application that generates PCAP files and corresponding CSV metadata.
*   **Data Mover Application**: The Python application (deployed as a separate RPM and `systemd` service) responsible for reliably detecting (via CSV files or directory scanning), acquiring, processing, uploading, and tracking all `.pcap` files generated by `exportcliv8` instances. It also detects "stuck" `exportcliv8` instances and creates trigger files to signal their restart.
*   **Instance (`exportcliv8`)**: A running copy of the `exportcliv8` application, identified by an instance parameter (e.g., `MAH11`).
*   **MAH Identifier**: A unique suffix (e.g., `MAH11`, `MAH12`, `MAH13`) used as the instance parameter for `exportcliv8` `systemd` template units.
*   **`base_dir`**: The root directory used by the Data Mover application, specified as `/opt/bit_mover`, under which all its operational directories are located.
*   **CSV Directory**: `/opt/bit_mover/csv/` - An input directory for the Data Mover. `exportcliv8` instances write their CSV metadata files here. Restart trigger files for `exportcliv8` are also placed here by the Data Mover.
*   **Source Directory**: `/opt/bit_mover/source/` - An input directory for the Data Mover. `exportcliv8` instances write their PCAP data files here.
*   **Work Directory**: `/opt/bit_mover/worker/` - An internal processing directory for the Data Mover. PCAP files are moved here from the `Source Directory` before upload attempts.
*   **Uploaded Directory**: `/opt/bit_mover/uploaded/` - An internal processing directory for the Data Mover. Successfully uploaded PCAP files are moved here.
*   **Dead Letter Directory**: `/opt/bit_mover/dead_letter/` - An internal processing directory for the Data Mover. PCAP files that fail to upload after retries (or due to non-retryable errors) are moved here.
*   **Trigger File**: A file created by the Data Mover application in the `CSV Directory` to signal that a specific `exportcliv8` instance needs to be restarted (e.g., `/opt/bit_mover/csv/MAH11.restart`).
*   **`systemd`**: The system and service manager for Linux, used to manage the lifecycle of `exportcliv8` instances and the Data Mover application.
*   **Template Unit**: A `systemd` unit file (e.g., `name@.service`) that can be instantiated multiple times with different instance parameters (e.g., `name@MAH11.service`). `%i` refers to the unescaped instance string, `%I` to the raw (potentially escaped) instance string.
*   **Exit Codes (`sysexits.h`)**: Standardized exit codes used by the Data Mover application to signal termination status to `systemd`.
*   **RPM**: RPM Package Manager, used for deploying the applications and their configurations.

## 2. System Overview & Context
The overall system is designed to reliably capture network data via multiple `exportcliv8` instances and ensure its transfer to a remote host.
`exportcliv8` instances run concurrently, each generating `.pcap` files in the shared `Source Directory` (`/opt/bit_mover/source/`) and corresponding metadata lines in unique CSV files within the shared `CSV Directory` (`/opt/bit_mover/csv/`).

The Data Mover application, a multi-threaded Python service, is the central component for managing this data flow. Its primary goal is to reliably detect, acquire, upload, and track all `.pcap` files, ensuring no data loss under normal operation.
Its workflow involves:
1.  Monitoring the `CSV Directory` for new entries signalling completed `.pcap` files.
2.  Periodically scanning the `Source Directory` to discover any "lost" files not signalled via CSV.
3.  Moving discovered and signalled `.pcap` files from the `Source Directory` to the `Work Directory` (`/opt/bit_mover/worker/`) for staging.
4.  Attempting to upload files from the `Work Directory` to a remote host.
5.  Moving successfully uploaded files to the `Uploaded Directory` (`/opt/bit_mover/uploaded/`).
6.  Moving files that permanently fail to upload to the `Dead Letter Directory` (`/opt/bit_mover/dead_letter/`).
7.  Detecting "stuck" `exportcliv8` instances (which fail to close `.pcap` files correctly) and creating trigger files in the `CSV Directory`.

`systemd` path units monitor these trigger files, initiating a restart of the problematic `exportcliv8` instance via a oneshot `systemd` service.

Both `exportcliv8` (as template instances) and the Data Mover are deployed via RPMs and managed as `systemd` services running under dedicated non-root system users. The RPMs establish the necessary directory structure under `/opt/bit_mover/` and base permissions, while the applications validate these prerequisites at startup. The Data Mover specifically validates that all its operational directories reside on the same filesystem to ensure atomic `mv` operations.

## 3. General Requirements (`exportcliv8`)

*   **GEN-001:** The system shall support running multiple (initially three) independent instances of the `exportcliv8` application concurrently.
*   **GEN-002:** Each `exportcliv8` instance shall be uniquely identifiable using an instance parameter (e.g., `MAH11`, `MAH12`, `MAH13`) used with `systemd` template units.
*   **GEN-003:** The `exportcliv8` executable is located at `/opt/bin/exportcliv8`.
*   **GEN-004:** All file paths generated by or for `exportcliv8` instances must align with the Data Mover application's directory structure rooted at `base_dir = /opt/bit_mover/` and incorporate the instance parameter (`%i`) for uniqueness.

## 4. Functional Requirements (`exportcliv8`)

### 4.1. `exportcliv8` Instance Configuration
*   **FR-CONF-001:** Each `exportcliv8` instance must be configurable with its own unique set of command-line parameters, managed via per-instance configuration files loaded by a `systemd` template unit.
*   **FR-CONF-002:** The `-H <csv_hash_file_path_prefix>` parameter for each instance must specify a unique path prefix within the `CSV Directory` (`/opt/bit_mover/csv/`), incorporating the instance parameter (e.g., `SHA256-HASH-%i`).
    *   Example for instance `MAH11`: `-H /opt/bit_mover/csv/SHA256-HASH-MAH11`
*   **FR-CONF-003:** The PCAP output directory prefix for each instance shall be specified as a *positional argument*, unique per instance (e.g., `/opt/bit_mover/source/%i`), and reside within the `Source Directory` (`/opt/bit_mover/source/`).
    *   Example for instance `MAH11`: `/opt/bit_mover/source/MAH11`
*   **FR-CONF-004:** The `-o` (`--overwrite`) flag SHALL be included in the command line for all `exportcliv8` instances.
    *   *Justification: This flag is required to ensure the CSV hash file (specified by `-H`) is truncated at the start of each `exportcliv8` run, which is necessary for the correct operation of the downstream Data Mover application.*
*   **FR-CONF-005:** Other command-line parameters (authentication tokens, timeout, target IP, port/ID, date/time ranges) must be configurable per instance, via per-instance configuration files (e.g., `/etc/exportcliv8/%i.conf`). The specific values for these parameters are an implementation detail to be defined during deployment.
    *   Example command structure (Instance `%i`):
        `/opt/bin/exportcliv8 -u <AUTH_TOKEN_U_from_%i.conf> -p <AUTH_TOKEN_P_from_%i.conf> -t 60 -H /opt/bit_mover/csv/SHA256-HASH-%i -o /opt/bit_mover/source/%i <IP_from_%i.conf> <PortID_from_%i.conf> <StartTime_from_%i.conf> <EndTime_from_%i.conf>`
*   **FR-CONF-006:** Authentication credentials (e.g., tokens) SHALL be managed securely using `systemd` credential management (e.g., `LoadCredential=`, `EnvironmentFile=`) with securely stored files. Credential files must be located in standard, secured paths (e.g., for `LoadCredential=`, files under `/etc/credstore/exportcliv8@%i/` or `/run/credstore/exportcliv8@%i/`). (See NFR-003).

### 4.2. Starting `exportcliv8` Instances
*   **FR-START-001:** `exportcliv8` instances shall be managed by a `systemd` template service unit (e.g., `exportcliv8@.service`).
*   **FR-START-002:** The template service unit shall load instance-specific parameters from per-instance configuration files (e.g., `/etc/exportcliv8/%i.conf`).
*   **FR-START-003:** Instances shall be startable via standard `systemd` commands (e.g., `sudo systemctl start exportcliv8@MAH11.service`).
*   **FR-START-004:** All `exportcliv8` instances SHALL be configured to start automatically on system boot and are intended to run 24x7. This is achieved by enabling the instantiated services (e.g., `sudo systemctl enable exportcliv8@MAH11.service`).
*   **FR-START-005 (Directory Validation):** The `exportcliv8@.service` unit SHALL include `ExecStartPre` directives to validate the existence and writability of its essential output directories (e.g., `/opt/bit_mover/source/%i` and `/opt/bit_mover/csv/`). Failure of these pre-start checks SHALL prevent the service instance from starting.

### 4.3. Stopping `exportcliv8` Instances
*   **FR-STOP-001:** Each `exportcliv8` instance shall be stoppable via its instantiated `systemd` service unit (e.g., `sudo systemctl stop exportcliv8@MAH11.service`).
*   **FR-STOP-002:** The stop mechanism should allow `exportcliv8` to perform a graceful shutdown. `systemd`'s default `SIGTERM` followed by `SIGKILL` after a timeout is acceptable.

### 4.4. Restarting `exportcliv8` Instances (Trigger-Based)
*   **FR-RESTART-001:** The system shall support restarting an individual `exportcliv8` instance in response to the creation of a specific trigger file.
*   **FR-RESTART-002:** The Data Mover application will create (e.g., `touch`) the trigger file when it detects a "stuck file" condition for a specific `exportcliv8` instance.
*   **FR-RESTART-003:** Trigger files shall be located in the `CSV Directory` (`/opt/bit_mover/csv/`) and named using the instance identifier (e.g., `MAH11.restart`).
*   **FR-RESTART-004:** A `systemd` template path unit (e.g., `exportcliv8-restart@.path`) shall monitor the respective trigger file for each instance.
    *   The path unit SHALL use `PathExists=/opt/bit_mover/csv/%i.restart`. Reliable removal of the trigger file by the oneshot service (FR-RESTART-006b) is crucial for allowing subsequent triggers for the same instance.
    *   The path unit's `Unit=` directive will specify the templated oneshot service to activate (e.g., `exportcliv8-restart@%i.service`).
    *   The path unit shall include `[Install] WantedBy=multi-user.target`.
*   **FR-RESTART-005:** Upon detection of its corresponding trigger file, the `systemd` path unit shall activate an instantiated `systemd` oneshot service unit (e.g., `exportcliv8-restart@%i.service`).
    *   The `[Unit]` section of this oneshot service should include `Description=`, `Wants=exportcliv8@%i.service`, and `After=exportcliv8@%i.service`.
*   **FR-RESTART-006:** The "restart action service" (e.g. `exportcliv8-restart@%i.service`) shall be `Type=oneshot` and perform:
    *   a. Restart the target `exportcliv8` instance (e.g., `ExecStart=/usr/bin/systemctl restart exportcliv8@%i.service`).
    *   b. Delete the trigger file (e.g., `ExecStartPost=-/usr/bin/rm -f /opt/bit_mover/csv/%i.restart`). The leading `-` makes removal non-fatal if the file is already gone.
*   **FR-RESTART-007:** The restart mechanism must ensure only the `exportcliv8` instance corresponding to the instance parameter (`%i`) of the detected trigger file is restarted.
*   **FR-RESTART-008:** The trigger file must be removed after the restart action is successfully initiated to prevent continuous restart loops from a single trigger event.
*   **FR-RESTART-009 (Permissions):** See NFR-007 for detailed file system permission strategy. The user running the Data Mover application must have permission to create trigger files in `/opt/bit_mover/csv/`. The user context of the restart action service must have permission to delete them.

## 5. Deployment Requirements (System-Level)
*   **DEP-001 (Directory Structure Creation):** The core directory structure (`/opt/bit_mover` and its operational subdirectories: `csv`, `source`, `worker`, `uploaded`, `dead_letter`) SHALL be created with correct initial ownership and permissions by the Data Mover application's RPM installation package.
*   **DEP-002 (User and Group Creation):** Dedicated non-root system users (`exportcliv8_user`, `datamover_user`) and a shared group (`datapipeline_group`) SHALL be created by the RPM installation process (e.g., of the Data Mover package or a base package). `exportcliv8_user` and `datamover_user` SHALL be members of `datapipeline_group`.

## 6. Non-Functional Requirements (System-Wide & `exportcliv8`)

*   **NFR-001 (Reliability & Stability):**
    *   Start, stop, and restart mechanisms must be reliable.
    *   Trigger-based restart of `exportcliv8` should consistently occur upon trigger file creation.
    *   Main `exportcliv8@.service` units should be configured for restart on failure (e.g., `Restart=on-failure`, `RestartSec=5s`).
    *   Crash loop protection SHALL be implemented for `exportcliv8@.service` units using `systemd`'s `StartLimitIntervalSec=` and `StartLimitBurst=` directives.
*   **NFR-002 (Logging):**
    *   Standard output/error from `exportcliv8` instances should be captured by `journald`. Service units SHALL use `SyslogIdentifier=` (e.g., `SyslogIdentifier=exportcliv8@%i`) for clear log tagging and filtering.
    *   The "restart action service" (`exportcliv8-restart@%i.service`) should log its actions to the journal, also using a distinct `SyslogIdentifier` (e.g., `SyslogIdentifier=exportcliv8-restart@%i`).
*   **NFR-003 (Security - Credentials & Privileges):**
    *   As per FR-CONF-006, authentication tokens/credentials for `exportcliv8` must be handled securely.
    *   Files containing credentials for `EnvironmentFile=` or `LoadCredential=` (e.g., under `/etc/credstore/exportcliv8@%i/` or a shared path for `EnvironmentFile=`) must have restricted permissions (e.g., mode `0600` owned by root, or `0640` readable only by root and the service's group (`datapipeline_group` or `exportcliv8_group`)).
    *   Credentials must not be hardcoded or exposed in world-readable `systemd` unit files or configuration files.
    *   The `exportcliv8-restart@.service` (oneshot restart action) typically requires elevated privileges (e.g., runs as root) to execute `systemctl restart`. This is an accepted operational requirement, and access to trigger this service (via file creation in `CSV Directory` by the `datamover_user`) is the control point.
*   **NFR-004 (Maintainability):**
    *   `systemd` template units SHALL be used for `exportcliv8` main services, path units, and restart action services to minimize duplication and simplify management of multiple instances.
    *   Per-instance configuration for `exportcliv8` SHALL be managed in separate configuration files (e.g., `/etc/exportcliv8/%i.conf`) loaded by the template units.
    *   All `systemd` unit files and configuration files should be well-commented. Package installation should place relevant documentation (e.g., this document, user-facing READMEs or man pages for operational procedures) in standard locations like `/usr/share/doc/<package-name>/`. `Documentation=` lines in unit files should point to these deployed resources.
*   **NFR-005 (Trigger Management - Data Mover Responsibility):**
    *   The Data Mover application should implement logic to manage the frequency of trigger file creation for a given `exportcliv8` instance, potentially including a cooldown period or debounce mechanism after a restart is triggered, to avoid overwhelming the system if an underlying issue persists.
*   **NFR-006 (Stale Trigger File Management):**
    *   Orphaned `.restart` trigger files (e.g., left over from an unclean system reboot) SHALL be cleaned up at boot time.
    *   This is best achieved using a `tmpfiles.d` configuration (e.g., `/etc/tmpfiles.d/exportcliv8-triggers.conf`) to remove any `*.restart` files in `/opt/bit_mover/csv/` during boot.
*   **NFR-007 (File System Permissions and Access Control):**
    *   A shared group (`datapipeline_group`) SHALL be used for `exportcliv8_user` and `datamover_user` to facilitate access to shared directories under `/opt/bit_mover/`.
    *   Directory `/opt/bit_mover/csv/`:
        *   Shall be group-owned by `datapipeline_group`. Owner can be `root` or `datamover_user`.
        *   Shall have the `setgid` bit enabled (permissions e.g., `2770` - `drwxrws---`). This ensures files/directories created within it inherit `datapipeline_group` ownership.
        *   `exportcliv8_user` (via its service) needs to write CSV files here.
        *   `datamover_user` (via its service) needs to read CSV files and create/delete `.restart` trigger files here.
    *   Directory `/opt/bit_mover/source/`:
        *   Shall be group-owned by `datapipeline_group`. Owner can be `root` or `exportcliv8_user`.
        *   Shall have the `setgid` bit enabled (permissions e.g., `2770` - `drwxrws---`).
        *   `exportcliv8_user` (via its service) needs to write PCAP files here.
        *   `datamover_user` (via its service) needs to read and move/delete PCAP files from here.
    *   Directories primarily managed by the Data Mover (`/opt/bit_mover/worker/`, `/opt/bit_mover/uploaded/`, `/opt/bit_mover/dead_letter/`):
        *   Shall be owned by `datamover_user` and group-owned by `datapipeline_group`.
        *   Permissions should allow full control for `datamover_user` and group read/execute for `datapipeline_group` (e.g., `2770` - `drwxrws---`).
    *   The `UMask=` directive in `systemd` service units for `exportcliv8_user` and `datamover_user` should be set appropriately (e.g., `UMask=0027`) to ensure files created by these services have correct group read permissions (`rw-r-----` for files), complementing the `setgid` behavior of parent directories for group ownership.

## 7. Assumptions (System-Wide)

*   **ASM-001:** The host system runs Oracle Linux 9 or a compatible Linux distribution with `systemd`.
*   **ASM-002:** The Data Mover application has the necessary permissions to create trigger files in `/opt/bit_mover/csv/` as per NFR-007 and FR-RESTART-009.
*   **ASM-003:** The `exportcliv8` application can be safely and effectively restarted by stopping and starting its process. A restart is known to resolve the "stuck file" issue.
*   **ASM-004:** The dedicated system users (`exportcliv8_user`, `datamover_user`) under which services run have necessary permissions as defined in NFR-007.
*   **ASM-005:** The core directory structure (`/opt/bit_mover/` and its subdirectories) SHALL be created with appropriate ownership and permissions by the Data Mover application's RPM installation package, as per DEP-001.
*   **ASM-006:** The string `SHA256-HASH` in the CSV filename prefix (`-H /opt/bit_mover/csv/SHA256-HASH-%i`) is a literal string.

## 8. Data Mover Application Management

This section outlines the requirements for managing the Data Mover application itself as a `systemd` service.

### 8.1. General Requirements
*   **DM-GEN-001:** The Data Mover application SHALL be managed as a `systemd` service (e.g., `datamover.service`).
*   **DM-GEN-002:** The service SHALL run under a dedicated non-root system user (`datamover_user`) and group (`datapipeline_group` or `datamover_user`'s primary group if distinct and appropriate for permissions).
*   **DM-GEN-003:** The application's entry point script and its configuration file (`app.ini`) path SHALL be configurable within the `systemd` service unit.
*   **DM-GEN-004 (Directory Validation):** At startup, the Data Mover application SHALL validate the existence and required properties of its `base_dir` and all operational subdirectories (`csv`, `source`, `worker`, `uploaded`, `dead_letter`). This validation SHALL include the critical check that all these directories reside on the same filesystem device as `base_dir` to ensure atomic `mv` operations. If validation fails, the application SHALL exit with an appropriate error code (e.g., `EX_CONFIG`, `EX_OSERR`).
*   **DM-GEN-005 (Core Goal):** The Data Mover service is responsible for the reliable detection, acquisition, upload, and tracking of `.pcap` files as described in Section 2 (System Overview & Context) and detailed in its own application documentation.

### 8.2. Functional Requirements
*   **DM-FR-START-001 (Startup):** The Data Mover service SHALL be configured to start automatically on system boot and is intended to run 24x7.
*   **DM-FR-START-002 (Configuration):** The `systemd` service unit SHALL specify the path to the Data Mover's configuration file (e.g., `app.ini`) via a command-line argument to the application.
*   **DM-FR-START-003 (Startup Order):** The `datamover.service` unit SHALL be configured to start `After` a `systemd` target (e.g., `exportcliv8.target`) that groups all `exportcliv8@.service` instances. This ensures `exportcliv8` services are attempted to start before the Data Mover.
*   **DM-FR-STOP-001 (Shutdown):** The service SHALL be stoppable via standard `systemd` commands (e.g., `sudo systemctl stop datamover.service`). The application's signal handlers are expected to manage graceful shutdown.
*   **DM-FR-RESTART-001 (Automatic Restart):** The `systemd` service unit SHALL be configured to automatically restart the Data Mover application if it exits due to a temporary failure or recoverable software error.
    *   `Restart=on-failure` is recommended.
    *   Specific exit codes like `EX_TEMPFAIL (75)`, `EX_SOFTWARE (70)`, `EX_OSERR (71)`, `EX_UNAVAILABLE (69)` (as defined by the application) should trigger a restart.
    *   Exit codes indicating permanent configuration issues (e.g., `EX_CONFIG (78)`, `EX_USAGE (64)`) should ideally not lead to indefinite rapid restarts (see DM-NFR-001 Crash Loop Protection).
*   **DM-FR-EXITCODES-001 (Exit Code Interpretation):** The `systemd` service unit may use `RestartPreventExitStatus=` to prevent restarts on specific fatal error codes (e.g., `EX_CONFIG`), if desired, to force manual intervention for such errors. The application's use of `EX_OK (0)` for successful shutdown aligns with `systemd` defaults.

### 8.3. Non-Functional Requirements
*   **DM-NFR-001 (Reliability & Stability):**
    *   The service must be reliable.
    *   Crash loop protection SHALL be implemented using `systemd`'s `StartLimitIntervalSec=` and `StartLimitBurst=` directives.
*   **DM-NFR-002 (Logging):**
    *   Standard output and error from the Data Mover application SHALL be captured by `journald`.
    *   The service unit SHALL use `SyslogIdentifier=` (e.g., `SyslogIdentifier=datamover`) for clear log tagging.
*   **DM-NFR-003 (Security):**
    *   The service SHALL run as a dedicated non-root user (`datamover_user`) with least privilege, as part of `datapipeline_group` for necessary shared directory access.
    *   The configuration file (`app.ini`) permissions should restrict write access (e.g., `0640 root:datamover_group` or `0640 root:datamover_user`'s primary group).
*   **DM-NFR-004 (Maintainability):**
    *   The `systemd` unit file should be well-commented.
    *   Documentation (including path to `app.ini`, log locations, and operational README) should be part of the RPM package (e.g., in `/usr/share/doc/datamover-app/`). `Documentation=` lines in the unit file should point to these deployed resources.
